/*
Module: Receiver Provider
Description: Grafana LGTMP Stack Receiver Provider
*/

declare "lgtmp_stack" {

	/********************************************
	* ARGUMENTS
	********************************************/
	argument "metrics_endpoint" {
		comment  = "Where to send collected metrics."
		optional = true
		default  = "http://mimir:8080"
	}

	argument "logs_endpoint" {
		comment  = "Where to send collected logs."
		optional = true
		default  = "http://loki:3100"
	}

	argument "traces_endpoint" {
		comment  = "Where to send collected traces."
		optional = true
		default  = "tempo:4317"
	}

	argument "profiles_endpoint" {
		comment  = "Where to send collected profiles."
		optional = true
		default  = "http://pyroscope:4040"
	}

	/********************************************
	* Setup Receivers
	********************************************/
	prometheus.remote_write "lgtmp_stack" {
		endpoint {
			url                    = argument.metrics_endpoint.value + "/api/v1/push"
			send_native_histograms = true
		}
	}

	loki.write "lgtmp_stack" {
		endpoint {
			url = argument.logs_endpoint.value + "/loki/api/v1/push"
		}
	}

	otelcol.exporter.otlp "lgtmp_stack" {
		client {
			endpoint = argument.traces_endpoint.value

			tls {
				insecure             = true
				insecure_skip_verify = true
			}
		}
	}

	pyroscope.write "lgtmp_stack" {
		endpoint {
			url = argument.profiles_endpoint.value
		}
	}

	/********************************************
	* EXPORTS
	********************************************/
	export "metrics_receiver" {
		value = prometheus.remote_write.lgtmp_stack.receiver
	}

	export "logs_receiver" {
		value = loki.write.lgtmp_stack.receiver
	}

	export "traces_receiver" {
		value = otelcol.exporter.otlp.lgtmp_stack.input
	}

	export "profiles_receiver" {
		value = pyroscope.write.lgtmp_stack.receiver
	}
}

declare "grafana_cloud" {

	/*
	To create a token:
		1. Navigate to the Grafana Cloud Portal: https://grafana.com/profile/org
		2. Go to either the Access Policies or API Keys page, located in the Security section
		3. Create an Access Policy or API token with the correct permissions

	The token must have permissions to read stack information. The setup of these permissions depends on the type of token:
		Access Policies need the stacks:read scope
		API Keys need at least the the MetricsPublisher role
	*/

	/********************************************
	* ARGUMENTS
	********************************************/
	argument "stack_name" {
		comment = "Name of your stack as shown in the account console"
	}

	argument "token" {
		comment = "Access policy token or API Key."
	}

	/********************************************
	* External information
	********************************************/
	remote.http "config_file" {
		url = "https://grafana.com/api/instances/" + argument.stack_name.value

		client {
			bearer_token = argument.token.value
		}
		poll_frequency = "24h"
	}

	/********************************************
	* Setup Receivers
	********************************************/
	prometheus.remote_write "grafana_cloud" {
		endpoint {
			url = json_decode(remote.http.config_file.content)["hmInstancePromUrl"] + "/api/prom/push"

			basic_auth {
				username = json_decode(remote.http.config_file.content)["hmInstancePromId"]
				password = argument.token.value
			}
		}
	}

	loki.write "grafana_cloud" {
		endpoint {
			url = json_decode(remote.http.config_file.content)["hlInstanceUrl"] + "/loki/api/v1/push"

			basic_auth {
				username = json_decode(remote.http.config_file.content)["hlInstanceId"]
				password = argument.token.value
			}
		}
	}

	otelcol.auth.basic "grafana_cloud" {
		username = json_decode(remote.http.config_file.content)["htInstanceId"]
		password = argument.token.value
	}

	otelcol.exporter.otlp "grafana_cloud" {
		client {
			endpoint = json_decode(remote.http.config_file.content)["htInstanceUrl"] + ":443"
			auth     = otelcol.auth.basic.grafana_cloud.handler
		}
	}

	pyroscope.write "grafana_cloud" {
		endpoint {
			url = json_decode(remote.http.config_file.content)["hpInstanceUrl"]

			basic_auth {
				username = json_decode(remote.http.config_file.content)["hpInstanceId"]
				password = argument.token.value
			}
		}
	}

	/********************************************
	* EXPORTS
	********************************************/
	export "metrics_receiver" {
		value = prometheus.remote_write.grafana_cloud.receiver
	}

	export "logs_receiver" {
		value = loki.write.grafana_cloud.receiver
	}

	export "traces_receiver" {
		value = otelcol.exporter.otlp.grafana_cloud.input
	}

	export "profiles_receiver" {
		value = pyroscope.write.grafana_cloud.receiver
	}

	export "stack_information" {
		value = json_decode(remote.http.config_file.content)
	}
}
